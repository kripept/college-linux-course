name: Update Project v2

on:
  pull_request:
    types: [opened, ready_for_review, reopened, synchronize, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      OWNER: virusneo1997-del
      REPO: ${{ github.event.repository.name }}
      PROJECT_NAME: "Автоматизация курсов"
      TODO: "To do"
      INPROGRESS: "In Progress"
      INREVIEW: "In review"
      DONE: "Done"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Find Project ID
        id: project
        run: |
          gh api graphql -f query='
            query($owner: String!, $name: String!) {
              user(login: $owner) {
                projectsV2(first: 50) {
                  nodes {
                    id
                    title
                  }
                }
              }
            }
          ' -F owner=$OWNER -F name=$REPO > out.json

          PROJECT_ID=$(jq -r ".data.user.projectsV2.nodes[] | select(.title==\"$PROJECT_NAME\") | .id" out.json)

          if [ -z "$PROJECT_ID" ]; then
            echo "Project not found!"
            exit 1
          fi

          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      - name: Add PR to Project (if missing)
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($project: ID!, $pr: Int!, $owner: String!, $repo: String!) {
              repository(owner:$owner, name:$repo) {
                pullRequest(number:$pr) {
                  id
                  projectItems(first:20) {
                    nodes { id }
                  }
                }
              }
            }
          ' -F project=$PROJECT_ID -F pr=${{ github.event.pull_request.number }} -F owner=$OWNER -F repo=$REPO \
            | jq -r ".data.repository.pullRequest.projectItems.nodes[0].id")

          if [ "$ITEM_ID" = "null" ] || [ -z "$ITEM_ID" ]; then
            echo "Adding PR to project..."
            ITEM_ID=$(gh api graphql -f query='
              mutation($project:ID!, $pr:ID!) {
                addProjectV2ItemById(input:{projectId:$project, contentId:$pr}) {
                  item { id }
                }
              }
            ' -F project=$PROJECT_ID -F pr=${{ github.event.pull_request.node_id }} \
              | jq -r ".data.addProjectV2ItemById.item.id")
          fi

          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_ENV

      - name: Get column IDs
        run: |
          gh api graphql -f query='
            query($project:ID!) {
              node(id:$project) {
                ... on ProjectV2 {
                  fields(first:20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }
          ' -F project=$PROJECT_ID > fields.json

          STATUS_FIELD_ID=$(jq -r '.data.node.fields.nodes[] | select(.name=="Status") | .id' fields.json)
          echo "STATUS_FIELD_ID=$STATUS_FIELD_ID" >> $GITHUB_ENV

          TODO_OPTION=$(jq -r ".data.node.fields.nodes[] | select(.name==\"Status\") | .options[] | select(.name==\"$TODO\") | .id" fields.json)
          INPROGRESS_OPTION=$(jq -r ".data.node.fields.nodes[] | select(.name==\"Status\") | .options[] | select(.name==\"$INPROGRESS\") | .id" fields.json)
          INREVIEW_OPTION=$(jq -r ".data.node.fields.nodes[] | select(.name==\"Status\") | .options[] | select(.name==\"$INREVIEW\") | .id" fields.json)
          DONE_OPTION=$(jq -r ".data.node.fields.nodes[] | select(.name==\"Status\") | .options[] | select(.name==\"$DONE\") | .id" fields.json)

          echo "TODO_OPTION=$TODO_OPTION" >> $GITHUB_ENV
          echo "INPROGRESS_OPTION=$INPROGRESS_OPTION" >> $GITHUB_ENV
          echo "INREVIEW_OPTION=$INREVIEW_OPTION" >> $GITHUB_ENV
          echo "DONE_OPTION=$DONE_OPTION" >> $GITHUB_ENV

      - name: Determine status
        id: status
        run: |
          if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "STATUS=$DONE_OPTION" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.state }}" == "closed" ]]; then
            echo "STATUS=$TODO_OPTION" >> $GITHUB_ENV
          elif [[ "${{ github.event.pull_request.requested_reviewers }}" != "[]" ]]; then
            echo "STATUS=$INREVIEW_OPTION" >> $GITHUB_ENV
          else
            echo "STATUS=$INPROGRESS_OPTION" >> $GITHUB_ENV
          fi

      - name: Update Project Status
        run: |
          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $field:ID!, $value:String!) {
              updateProjectV2ItemFieldValue(input:{
                projectId:$project,
                itemId:$item,
                fieldId:$field,
                value:{singleSelectOptionId:$value}
              }) {
                projectV2Item { id }
              }
            }
          ' -F project=$PROJECT_ID -F item=$ITEM_ID -F field=$STATUS_FIELD_ID -F value=$STATUS
