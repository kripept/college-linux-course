name: Проверка задания студента

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-student:
    runs-on: ubuntu-latest

    steps:
      - name: Информация о Pull Request
        run: |
          echo "PR от студента: ${{ github.event.pull_request.user.login }}"
          echo "Репозиторий студента: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "Ветка: ${{ github.event.pull_request.head.ref }}"

      # Клонируем код студента (их PR ветку)
      - name: Checkout student's repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      ###################################
      #  Основная Автопроверка (Вариант А)
      ###################################

      - name: Определяем урок из пути
        id: lesson
        run: |
          # Ищем номер урока по имени папки в PR
          ls -R .
          lesson=$(find . -maxdepth 2 -type d -name "lesson-*" | head -n 1)

          if [ -z "$lesson" ]; then
            echo "lesson=none" >> $GITHUB_OUTPUT
          else
            lesson_name=$(basename "$lesson")
            echo "lesson=$lesson_name" >> $GITHUB_OUTPUT
          fi

      - name: Проверяем структуру
        run: |
          if [ "${{ steps.lesson.outputs.lesson }}" = "none" ]; then
            echo "::error ::Не найдена папка урока (например, lesson-01)."
            exit 1
          fi

          echo "Найден урок: ${{ steps.lesson.outputs.lesson }}"

          lesson_dir="${{ steps.lesson.outputs.lesson }}"

          # Проверяем наличие результата
          if [ ! -f "$lesson_dir/student-report.md" ]; then
            echo "::error ::В папке урока нет файла student-report.md"
            exit 1
          fi

          echo "Структура валидна ✔"

      - name: Проверяем содержимое student-report.md
        run: |
          file="${{ steps.lesson.outputs.lesson }}/student-report.md"

          echo "---- Содержимое ----"
          cat "$file"
          echo "--------------------"

          if ! grep -qi "ответ" "$file"; then
            echo "::warning ::Файл есть, но возможно пустой или без описания решения."
          fi

      - name: Успешная валидация
        if: success()
        run: echo "Автопроверка успешно завершена ✔ Студент молодец!"

      - name: Неуспешная валидация
        if: failure()
        run: echo "Автопроверка завершилась ошибкой ❌ Проверьте замечания выше."
