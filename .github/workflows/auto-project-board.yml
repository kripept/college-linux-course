name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board (Classic)

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed, converted_to_draft]
  pull_request_review:
    types: [submitted]

jobs:
  automate-project:
    runs-on: ubuntu-latest
    steps:
      - name: üéØ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò (Classic Projects) ===');
            
            const { pull_request } = context.payload;
            if (!pull_request) {
              console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
              return;
            }
            
            const author = pull_request.user.login;
            const prNumber = pull_request.number;
            const prAction = context.payload.action;
            const prState = pull_request.state;
            const prMerged = pull_request.merged;
            const prTitle = pull_request.title;
            const prDraft = pull_request.draft;
            
            console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
            console.log(`üî¢ –ù–æ–º–µ—Ä PR: ${prNumber}`);
            console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
            console.log(`üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${prTitle}`);
            console.log(`üîÑ –°—Ç–∞—Ç—É—Å PR: ${prState}`);
            console.log(`‚úÖ –ú–µ—Ä–∂: ${prMerged}`);
            console.log(`üìù –ß–µ—Ä–Ω–æ–≤–∏–∫: ${prDraft}`);
            
            // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –¶–ï–õ–ï–í–£–Æ –ö–û–õ–û–ù–ö–£
            let targetColumn = null;
            
            if (context.eventName === 'pull_request') {
              console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ pull_request: ${prAction}`);
              
              switch (prAction) {
                case 'opened':
                  if (prDraft) {
                    console.log('üéØ PR –æ—Ç–∫—Ä—ã—Ç –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ - –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ To do');
                    targetColumn = 'To do';
                  } else {
                    console.log('üéØ PR –æ—Ç–∫—Ä—ã—Ç - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ In Progress');
                    targetColumn = 'In Progress';
                  }
                  break;
                  
                case 'reopened':
                  console.log('üéØ PR –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ In Progress');
                  targetColumn = 'In Progress';
                  break;
                  
                case 'ready_for_review':
                  console.log('üéØ PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ In Progress');
                  targetColumn = 'In Progress';
                  break;
                  
                case 'converted_to_draft':
                  console.log('üéØ PR –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ To do');
                  targetColumn = 'To do';
                  break;
                  
                case 'closed':
                  if (prMerged) {
                    console.log('üéØ PR –º–µ—Ä–∂–µ–Ω - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ Done');
                    targetColumn = 'Done';
                  } else {
                    console.log('üéØ PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –º–µ—Ä–∂–∞ - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ To do');
                    targetColumn = 'To do';
                  }
                  break;
                  
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
              }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —Ä–µ–≤—å—é
            if (context.eventName === 'pull_request_review') {
              const reviewState = context.payload.review.state;
              console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–≤—å—é: ${reviewState}`);
              
              if (reviewState === 'approved') {
                console.log('üéØ –†–µ–≤—å—é approved - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ Done');
                targetColumn = 'Done';
              } else if (reviewState === 'changes_requested') {
                console.log('üéØ –†–µ–≤—å—é —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ In Progress');
                targetColumn = 'In Progress';
              }
            }
            
            if (!targetColumn) {
              console.log('‚ÑπÔ∏è –ö–æ–ª–æ–Ω–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è');
              return;
            }
            
            console.log(`üéØ –¶–µ–ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: ${targetColumn}`);
            
            try {
              // 1. –ü–û–õ–£–ß–ê–ï–ú –í–°–ï –ü–†–û–ï–ö–¢–´ –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              console.log(`üìã –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${projects.data.length}`);
              
              if (projects.data.length === 0) {
                console.log('‚ùå –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤!');
                console.log('üí° –°–æ–∑–¥–∞–π—Ç–µ Classic Project –≤—Ä—É—á–Ω—É—é');
                return;
              }
              
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç (–æ–±—ã—á–Ω–æ –æ–Ω –æ–¥–∏–Ω)
              const project = projects.data[0];
              console.log(`üìä –†–∞–±–æ—Ç–∞–µ–º —Å –ø—Ä–æ–µ–∫—Ç–æ–º: "${project.name}" (ID: ${project.id})`);
              
              // 2. –ü–û–õ–£–ß–ê–ï–ú –ö–û–õ–û–ù–ö–ò –ü–†–û–ï–ö–¢–ê
              const columns = await github.rest.projects.listColumns({
                project_id: project.id,
              });
              
              console.log('üìã –ö–æ–ª–æ–Ω–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', columns.data.map(col => col.name));
              
              const targetColumnObj = columns.data.find(col => col.name === targetColumn);
              if (!targetColumnObj) {
                console.log(`‚ùå –ö–æ–ª–æ–Ω–∫–∞ "${targetColumn}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏:', columns.data.map(col => col.name));
                return;
              }
              
              console.log(`üìã –ù–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: ${targetColumnObj.name} (ID: ${targetColumnObj.id})`);
              
              // 3. –ò–©–ï–ú –°–£–©–ï–°–¢–í–£–Æ–©–£–Æ –ö–ê–†–¢–û–ß–ö–£ –î–õ–Ø –≠–¢–û–ì–û PR
              let existingCard = null;
              
              for (const column of columns.data) {
                const cards = await github.rest.projects.listCards({
                  column_id: column.id,
                });
                
                for (const card of cards.data) {
                  if (card.content_url && card.content_url.includes(`/issues/${prNumber}`)) {
                    existingCard = card;
                    console.log(`üìé –ù–∞–π–¥–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ "${column.name}"`);
                    break;
                  }
                }
                if (existingCard) break;
              }
              
              // 4. –°–û–ó–î–ê–ï–ú –ò–õ–ò –ü–ï–†–ï–ú–ï–©–ê–ï–ú –ö–ê–†–¢–û–ß–ö–£
              if (existingCard) {
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                console.log(`üîÑ –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∫–æ–ª–æ–Ω–∫—É: ${targetColumn}`);
                await github.rest.projects.moveCard({
                  card_id: existingCard.id,
                  position: 'bottom',
                  column_id: targetColumnObj.id,
                });
                console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤: ${targetColumn}`);
              } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                console.log(`üîÑ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∫–æ–ª–æ–Ω–∫–µ: ${targetColumn}`);
                await github.rest.projects.createCard({
                  column_id: targetColumnObj.id,
                  content_id: pull_request.id,
                  content_type: 'PullRequest',
                });
                console.log(`‚úÖ –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤: ${targetColumn}`);
              }
              
              console.log(`üéâ –£–°–ü–ï–•: PR #${prNumber} –∞–≤—Ç–æ—Ä–∞ ${author} –æ–±—Ä–∞–±–æ—Ç–∞–Ω!`);
              
            } catch (error) {
              console.error('üí• –û–®–ò–ë–ö–ê:', error.message);
              console.log('üîß –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', JSON.stringify(error, null, 2));
            }
            
            console.log('=== üèÅ –ó–ê–í–ï–†–®–ï–ù–ò–ï –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');